<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Signature Client ‚Äî SOS ORDI 03</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    margin:0;
    background:#f3f5f4;
    font-family:"Inter", sans-serif;
}

.header {
    background:#16a34a;
    color:white;
    text-align:center;
    padding:16px;
    font-size:22px;
    font-weight:800;
}

.container {
    max-width:600px;
    margin:auto;
    padding:15px;
}

canvas {
    background:white;
    border-radius:14px;
    width:100%;
    height:260px;
    touch-action:none; 
    border:2px solid #16a34a;
}

.btn {
    padding:12px 16px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    margin-top:10px;
}

.btn-green { background:#16a34a; color:white; }
.btn-red { background:#dc2626; color:white; }
.btn-blue { background:#2563eb; color:white; }

.center {
    text-align:center;
    margin-top:20px;
}

.preview {
    margin-top:20px;
    text-align:center;
}

.preview img {
    max-width:90%;
    border-radius:10px;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<div class="header">‚úç Signature Client</div>

<div class="container">

    <p>Le client doit signer ci-dessous :</p>

    <canvas id="pad"></canvas>

    <div class="center">
        <button class="btn btn-red" onclick="clearPad()">üßπ Effacer</button>
        <button class="btn btn-blue" onclick="saveSignature()">üíæ Enregistrer</button>
    </div>

    <div class="preview">
        <h3>Aper√ßu :</h3>
        <img id="sigPreview" style="display:none">
    </div>

    <div class="center">
        <button class="btn btn-green" onclick="history.back()">‚¨Ö Retour</button>
    </div>

</div>

<script type="module">

import { db } from "./scripts/firebase-config.js";
import { supabase } from "./scripts/supabase-config.js";
import {
    doc,
    updateDoc,
    getDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const id = params.get("id");

// CANVAS
const canvas = document.getElementById("pad");
const ctx = canvas.getContext("2d");

let drawing = false;

// Ajuste la r√©solution r√©elle du canvas
function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
}
resizeCanvas();

// EVENTS
canvas.addEventListener("mousedown", start);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("mouseup", end);

canvas.addEventListener("touchstart", startTouch, { passive:false });
canvas.addEventListener("touchmove", drawTouch, { passive:false });
canvas.addEventListener("touchend", end);

// DESSIN SOURIS
function start(e) {
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.offsetX, e.offsetY);
}

function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";

    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
}

function end() {
    drawing = false;
}

// DESSIN TOUCH
function startTouch(e) {
    e.preventDefault();
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}

function drawTouch(e) {
    e.preventDefault();
    if (!drawing) return;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    ctx.lineWidth = 3;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
}

// CLEAR
window.clearPad = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
};

// SAVE SIGNATURE
window.saveSignature = async function() {

    const dataURL = canvas.toDataURL("image/png");

    const blob = await (await fetch(dataURL)).blob();
    const path = `signatures/${id}_${Date.now()}.png`;

    // UPLOAD SUPABASE
    const { error } = await supabase.storage
        .from("sav-files")
        .upload(path, blob, { upsert: true });

    if (error) return alert("Erreur upload : " + error.message);

    const { data: publicUrl } = supabase.storage
        .from("sav-files")
        .getPublicUrl(path);

    // FIRESTORE
    await updateDoc(doc(db, "fiches", id), {
        signature: publicUrl.publicUrl
    });

    // AFFICHAGE
    document.getElementById("sigPreview").src = publicUrl.publicUrl;
    document.getElementById("sigPreview").style.display = "block";

    alert("‚úî Signature enregistr√©e !");
};

// CHARGEMENT SIGNATURE EXISTANTE
async function loadSignature() {
    const snap = await getDoc(doc(db, "fiches", id));
    if (!snap.exists()) return;

    const f = snap.data();

    if (f.signature) {
        document.getElementById("sigPreview").src = f.signature;
        document.getElementById("sigPreview").style.display = "block";
    }
}
load();

</script>

</body>
</html>
